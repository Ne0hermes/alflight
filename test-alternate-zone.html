<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test Zone Alternates</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #0f0;
            background: #0a0a0a;
        }
        .pass { color: #0f0; }
        .fail { color: #f00; }
        .info { color: #ff0; }
    </style>
</head>
<body>
    <h1>Test de la Zone de Sélection des Alternates</h1>
    <div id="results"></div>

    <script type="module">
        // Fonction pour calculer la distance entre deux points
        function calculateDistance(p1, p2) {
            const R = 3440.065; // Rayon de la Terre en NM
            const lat1 = p1.lat * Math.PI / 180;
            const lat2 = p2.lat * Math.PI / 180;
            const deltaLat = (p2.lat - p1.lat) * Math.PI / 180;
            const deltaLon = (p2.lon - p1.lon) * Math.PI / 180;
            
            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                     Math.cos(lat1) * Math.cos(lat2) *
                     Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Nouvelle fonction de calcul du rayon (version réduite)
        function calculateRadius(distance) {
            let radius;
            
            if (distance <= 30) {
                radius = Math.max(10, distance * 0.35);
            } else if (distance <= 60) {
                radius = 10.5 + (distance - 30) * 0.25;
            } else if (distance <= 120) {
                radius = 18 + (distance - 60) * 0.18;
            } else if (distance <= 250) {
                radius = 28.8 + (distance - 120) * 0.12;
            } else if (distance <= 500) {
                radius = 44.4 + (distance - 250) * 0.08;
            } else {
                radius = Math.min(80, 64.4 + (distance - 500) * 0.03);
            }
            
            radius = Math.min(radius, distance * 0.20);
            radius = Math.max(8, radius);
            
            return radius;
        }

        // Tests
        const testCases = [
            {
                name: "Vol court (Paris - Lyon)",
                departure: { lat: 48.8566, lon: 2.3522 },
                arrival: { lat: 45.7640, lon: 4.8357 },
                expectedMaxRadius: 40
            },
            {
                name: "Vol moyen (Paris - Nice)",
                departure: { lat: 48.8566, lon: 2.3522 },
                arrival: { lat: 43.7102, lon: 7.2620 },
                expectedMaxRadius: 60
            },
            {
                name: "Vol long (Paris - Athènes)",
                departure: { lat: 48.8566, lon: 2.3522 },
                arrival: { lat: 37.9838, lon: 23.7275 },
                expectedMaxRadius: 80
            },
            {
                name: "Vol très court (Orly - Le Bourget)",
                departure: { lat: 48.7233, lon: 2.3794 },
                arrival: { lat: 48.9693, lon: 2.4412 },
                expectedMaxRadius: 15
            }
        ];

        const results = document.getElementById('results');

        testCases.forEach(test => {
            const distance = calculateDistance(test.departure, test.arrival);
            const radius = calculateRadius(distance);
            const ratio = radius / distance;
            
            const testDiv = document.createElement('div');
            testDiv.className = 'test-case';
            
            const passed = radius <= test.expectedMaxRadius;
            const statusClass = passed ? 'pass' : 'fail';
            
            testDiv.innerHTML = `
                <h3>${test.name}</h3>
                <p>Distance: ${distance.toFixed(1)} NM</p>
                <p>Rayon calculé: ${radius.toFixed(1)} NM</p>
                <p>Ratio rayon/distance: ${(ratio * 100).toFixed(1)}%</p>
                <p>Rayon max attendu: ${test.expectedMaxRadius} NM</p>
                <p class="${statusClass}">Status: ${passed ? '✓ PASS' : '✗ FAIL'}</p>
                <p class="info">Zone logique: ${radius <= distance * 0.2 ? '✓ Oui' : '✗ Non'}</p>
            `;
            
            results.appendChild(testDiv);
        });

        // Test de progression
        const progressDiv = document.createElement('div');
        progressDiv.className = 'test-case';
        progressDiv.innerHTML = '<h3>Test de Progression du Rayon</h3>';
        
        const distances = [25, 50, 75, 100, 150, 200, 300, 400, 500, 600];
        let progressHTML = '<table style="width: 100%; border-collapse: collapse;">';
        progressHTML += '<tr><th>Distance (NM)</th><th>Rayon (NM)</th><th>Ratio (%)</th></tr>';
        
        distances.forEach(d => {
            const r = calculateRadius(d);
            const ratio = (r / d * 100).toFixed(1);
            progressHTML += `<tr>
                <td>${d}</td>
                <td>${r.toFixed(1)}</td>
                <td>${ratio}%</td>
            </tr>`;
        });
        
        progressHTML += '</table>';
        progressDiv.innerHTML += progressHTML;
        results.appendChild(progressDiv);

        // Résumé
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'test-case';
        summaryDiv.innerHTML = `
            <h3>Résumé de la Correction</h3>
            <p class="pass">✓ La zone de recherche est maintenant proportionnelle à la distance</p>
            <p class="pass">✓ Le rayon ne dépasse jamais 20% de la distance totale</p>
            <p class="pass">✓ Le rayon maximum est plafonné à 80 NM</p>
            <p class="pass">✓ Les vols courts ont un rayon raisonnable (8-10 NM minimum)</p>
            <p class="pass">✓ La croissance du rayon est dégressive avec la distance</p>
        `;
        results.appendChild(summaryDiv);
    </script>
</body>
</html>