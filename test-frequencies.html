<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test Fr√©quences AIXM</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .freq-display {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .freq-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üéØ Test des Fr√©quences AIXM</h1>
    
    <div class="test-section">
        <h2>1. Test du Parser AIXM</h2>
        <button onclick="testAIXMParser()">Tester l'extraction AIXM</button>
        <div id="aixm-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test du VAC Store</h2>
        <button onclick="testVACStore()">V√©rifier les donn√©es du store</button>
        <div id="store-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Test d'import complet LFST</h2>
        <button onclick="testFullImport()">Import complet LFST</button>
        <div id="import-result"></div>
    </div>

    <script type="module">
        // Import des modules n√©cessaires
        import { aixmParser } from '/src/services/aixmParser.js';
        
        window.testAIXMParser = async function() {
            const resultDiv = document.getElementById('aixm-result');
            resultDiv.innerHTML = '<p>‚è≥ Test en cours...</p>';
            
            try {
                // Charger et parser les donn√©es
                await aixmParser.loadAndParse();
                
                // R√©cup√©rer les donn√©es de LFST
                const lfst = await aixmParser.getAerodromeByICAO('LFST');
                
                if (!lfst) {
                    resultDiv.innerHTML = '<div class="error">‚ùå LFST non trouv√© dans les donn√©es AIXM</div>';
                    return;
                }
                
                // Afficher les r√©sultats
                let html = '<div class="success">‚úÖ LFST trouv√© avec succ√®s!</div>';
                
                // Informations g√©n√©rales
                html += '<div class="freq-display">';
                html += '<h3>Informations g√©n√©rales</h3>';
                html += `<div class="freq-item">üìç Nom: ${lfst.name}</div>`;
                html += `<div class="freq-item">üèôÔ∏è Ville: ${lfst.city || 'N/A'}</div>`;
                html += `<div class="freq-item">üìè Altitude: ${lfst.elevation?.value || 0} ${lfst.elevation?.unit || 'FT'}</div>`;
                html += '</div>';
                
                // Fr√©quences
                html += '<div class="freq-display">';
                html += '<h3>üìª Fr√©quences extraites</h3>';
                
                if (lfst.frequencies && Object.keys(lfst.frequencies).length > 0) {
                    let totalFreq = 0;
                    for (const [type, freqs] of Object.entries(lfst.frequencies)) {
                        if (Array.isArray(freqs) && freqs.length > 0) {
                            html += `<div class="freq-item"><strong>${type.toUpperCase()}:</strong>`;
                            freqs.forEach(f => {
                                html += `<br>  ‚Ä¢ ${f.frequency} MHz`;
                                if (f.schedule) html += ` (${f.schedule})`;
                                if (f.remarks) html += ` - ${f.remarks}`;
                                totalFreq++;
                            });
                            html += '</div>';
                        }
                    }
                    html += `<div class="success">Total: ${totalFreq} fr√©quences trouv√©es</div>`;
                } else {
                    html += '<div class="error">‚ùå Aucune fr√©quence trouv√©e</div>';
                }
                html += '</div>';
                
                // Pistes
                html += '<div class="freq-display">';
                html += '<h3>üõ¨ Pistes</h3>';
                if (lfst.runways && lfst.runways.length > 0) {
                    lfst.runways.forEach(rwy => {
                        html += `<div class="freq-item">`;
                        html += `Piste ${rwy.designation || 'N/A'}: `;
                        html += `${rwy.length || 0}m x ${rwy.width || 0}m`;
                        if (rwy.qfu) html += ` (QFU: ${rwy.qfu}¬∞)`;
                        html += '</div>';
                    });
                } else {
                    html += '<div class="error">Aucune piste trouv√©e</div>';
                }
                html += '</div>';
                
                // Afficher le JSON complet
                html += '<details>';
                html += '<summary>Voir les donn√©es compl√®tes (JSON)</summary>';
                html += '<pre>' + JSON.stringify(lfst, null, 2) + '</pre>';
                html += '</details>';
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
                console.error('Erreur test AIXM:', error);
            }
        };
        
        window.testVACStore = function() {
            const resultDiv = document.getElementById('store-result');
            
            if (!window.vacStore) {
                resultDiv.innerHTML = '<div class="error">‚ùå VAC Store non disponible</div>';
                return;
            }
            
            const state = window.vacStore.getState();
            const charts = state.charts || {};
            const lfstChart = charts['LFST'];
            
            let html = '<div class="freq-display">';
            html += '<h3>√âtat du VAC Store</h3>';
            html += `<div class="freq-item">Nombre de cartes: ${Object.keys(charts).length}</div>`;
            
            if (lfstChart) {
                html += '<div class="success">‚úÖ LFST pr√©sent dans le store</div>';
                
                // V√©rifier les diff√©rents emplacements possibles des fr√©quences
                const locations = [
                    { path: 'frequencies', data: lfstChart.frequencies },
                    { path: 'extractedData.frequencies', data: lfstChart.extractedData?.frequencies }
                ];
                
                html += '<h4>Emplacements des fr√©quences:</h4>';
                locations.forEach(loc => {
                    if (loc.data && Object.keys(loc.data).length > 0) {
                        html += `<div class="success">‚úÖ Fr√©quences trouv√©es dans: ${loc.path}</div>`;
                        html += '<pre>' + JSON.stringify(loc.data, null, 2) + '</pre>';
                    } else {
                        html += `<div class="error">‚ùå Pas de fr√©quences dans: ${loc.path}</div>`;
                    }
                });
                
            } else {
                html += '<div class="error">‚ùå LFST non trouv√© dans le store</div>';
                html += '<p>Cliquez sur "Import complet LFST" pour importer les donn√©es</p>';
            }
            
            html += '</div>';
            resultDiv.innerHTML = html;
        };
        
        window.testFullImport = async function() {
            const resultDiv = document.getElementById('import-result');
            resultDiv.innerHTML = '<p>‚è≥ Import en cours...</p>';
            
            try {
                // Simuler l'import comme dans VACModule
                const fullAerodromeData = await aixmParser.getAerodromeByICAO('LFST');
                
                if (!fullAerodromeData) {
                    resultDiv.innerHTML = '<div class="error">‚ùå Impossible de r√©cup√©rer les donn√©es LFST</div>';
                    return;
                }
                
                // Cr√©er l'objet VAC comme dans le module
                const vacData = {
                    icao: 'LFST',
                    name: fullAerodromeData.name,
                    city: fullAerodromeData.city,
                    type: 'AIXM_COMPLETE',
                    isDownloaded: true,
                    isCustom: false,
                    downloadDate: new Date().toISOString(),
                    source: 'AIXM4.5/SIA',
                    coordinates: fullAerodromeData.coordinates,
                    magneticVariation: fullAerodromeData.magneticVariation,
                    transitionAltitude: fullAerodromeData.transitionAltitude,
                    referencePoint: fullAerodromeData.referencePoint,
                    // Fr√©quences au niveau racine
                    frequencies: fullAerodromeData.frequencies || {},
                    extractedData: {
                        airportName: fullAerodromeData.name,
                        airportElevation: fullAerodromeData.elevation?.value || 0,
                        airportType: fullAerodromeData.type,
                        runways: fullAerodromeData.runways || [],
                        // Fr√©quences dans extractedData aussi
                        frequencies: fullAerodromeData.frequencies || {},
                        navaids: fullAerodromeData.navaids || [],
                        iata: fullAerodromeData.iata,
                        city: fullAerodromeData.city,
                        transitionAltitude: fullAerodromeData.transitionAltitude,
                        referencePoint: fullAerodromeData.referencePoint,
                        dataSource: 'AIXM4.5/SIA',
                        airac: '2025-09-04',
                        extractionDate: new Date().toISOString(),
                        confidenceScore: 1.0,
                        autoExtracted: true
                    }
                };
                
                // Afficher le r√©sultat
                let html = '<div class="success">‚úÖ Import simul√© avec succ√®s!</div>';
                html += '<div class="freq-display">';
                html += '<h3>Structure des donn√©es VAC cr√©√©e</h3>';
                
                // V√©rifier les fr√©quences aux deux emplacements
                html += '<h4>Fr√©quences au niveau racine:</h4>';
                if (vacData.frequencies && Object.keys(vacData.frequencies).length > 0) {
                    html += '<div class="success">‚úÖ Pr√©sentes</div>';
                    html += '<pre>' + JSON.stringify(vacData.frequencies, null, 2) + '</pre>';
                } else {
                    html += '<div class="error">‚ùå Absentes</div>';
                }
                
                html += '<h4>Fr√©quences dans extractedData:</h4>';
                if (vacData.extractedData.frequencies && Object.keys(vacData.extractedData.frequencies).length > 0) {
                    html += '<div class="success">‚úÖ Pr√©sentes</div>';
                    html += '<pre>' + JSON.stringify(vacData.extractedData.frequencies, null, 2) + '</pre>';
                } else {
                    html += '<div class="error">‚ùå Absentes</div>';
                }
                
                html += '</div>';
                
                // Option pour sauvegarder dans le store
                if (window.vacStore) {
                    html += '<button onclick="saveToStore()">üíæ Sauvegarder dans le store</button>';
                    window.tempVacData = vacData;
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
                console.error('Erreur import:', error);
            }
        };
        
        window.saveToStore = function() {
            if (window.vacStore && window.tempVacData) {
                const { addCustomChart } = window.vacStore.getState();
                addCustomChart('LFST', window.tempVacData);
                alert('‚úÖ Donn√©es sauvegard√©es dans le store!');
                // Rafra√Æchir l'affichage du store
                testVACStore();
            }
        };
        
        // Test automatique au chargement
        window.addEventListener('load', () => {
            console.log('üöÄ Page de test des fr√©quences charg√©e');
            console.log('Modules disponibles:', {
                aixmParser: typeof aixmParser !== 'undefined',
                vacStore: typeof window.vacStore !== 'undefined'
            });
        });
    </script>
</body>
</html>