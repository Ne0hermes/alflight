<!DOCTYPE html>
<html>
<head>
    <title>Cleanup VAC Storage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #dc2626;
            margin-bottom: 20px;
        }
        button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        button:hover {
            background: #b91c1c;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
        }
        .success {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #065f46;
        }
        .info {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            color: #1e40af;
        }
        .warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #78350f;
        }
        pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.5;
        }
        .vac-item {
            padding: 10px;
            margin: 5px 0;
            background: #f9fafb;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Nettoyage VAC Storage</h1>

        <p style="margin-bottom: 20px; color: #6b7280;">
            Ce script va supprimer d√©finitivement les cartes VAC suivantes du localStorage :
        </p>

        <div id="vacList"></div>

        <button onclick="cleanupVACs()" id="cleanupBtn">
            üóëÔ∏è Supprimer LFGA, LFST, LFSH, LFGY
        </button>

        <button onclick="showCurrentStorage()" style="background: #3b82f6; margin-left: 10px;">
            üëÅÔ∏è Afficher l'√©tat actuel
        </button>

        <div id="result"></div>
    </div>

    <script>
        const TO_DELETE = ['LFGA', 'LFST', 'LFSH', 'LFGY'];

        // Afficher la liste des VAC √† supprimer au chargement
        window.addEventListener('DOMContentLoaded', () => {
            showVACsToDelete();
        });

        function showVACsToDelete() {
            const vacListDiv = document.getElementById('vacList');
            let html = '';

            const vacStorage = localStorage.getItem('vac-storage');
            if (vacStorage) {
                const parsed = JSON.parse(vacStorage);
                const charts = parsed.state?.charts || {};

                TO_DELETE.forEach(icao => {
                    if (charts[icao]) {
                        const chart = charts[icao];
                        html += `<div class="vac-item">
                            <strong>${icao}</strong> - ${chart.name || 'N/A'}
                            <br><small>Import√© le: ${new Date(chart.downloadDate || chart.uploadDate).toLocaleDateString('fr-FR')}</small>
                            <br><small>Source: ${chart.isCustom ? 'Import manuel' : 'SIA'}</small>
                        </div>`;
                    } else {
                        html += `<div class="vac-item" style="opacity: 0.5; border-left-color: #9ca3af;">
                            <strong>${icao}</strong> - <em>D√©j√† absent</em>
                        </div>`;
                    }
                });
            } else {
                html = '<div class="warning">‚ö†Ô∏è Aucun vac-storage trouv√© dans localStorage</div>';
            }

            vacListDiv.innerHTML = html;
        }

        function showCurrentStorage() {
            const resultDiv = document.getElementById('result');
            let html = '<div class="info"><h3>üì¶ √âtat actuel du localStorage</h3>';

            // vac-storage
            const vacStorage = localStorage.getItem('vac-storage');
            if (vacStorage) {
                const parsed = JSON.parse(vacStorage);
                const charts = parsed.state?.charts || {};
                const icaos = Object.keys(charts);

                html += `<p><strong>vac-storage:</strong> ${icaos.length} a√©rodromes</p>`;
                html += `<p>ICAOs: ${icaos.join(', ') || 'Aucun'}</p>`;
            } else {
                html += '<p><strong>vac-storage:</strong> Vide</p>';
            }

            // customVACCharts
            const customCharts = localStorage.getItem('customVACCharts');
            if (customCharts) {
                const parsed = JSON.parse(customCharts);
                const icaos = Object.keys(parsed);

                html += `<p><strong>customVACCharts:</strong> ${icaos.length} a√©rodromes</p>`;
                html += `<p>ICAOs: ${icaos.join(', ') || 'Aucun'}</p>`;
            } else {
                html += '<p><strong>customVACCharts:</strong> Vide</p>';
            }

            html += '</div>';
            resultDiv.innerHTML = html;
        }

        async function cleanupVACs() {
            const resultDiv = document.getElementById('result');
            const cleanupBtn = document.getElementById('cleanupBtn');

            cleanupBtn.disabled = true;
            resultDiv.innerHTML = '<div class="info">‚è≥ Nettoyage en cours...</div>';

            let logs = [];
            let deletedCount = 0;

            // 1. Clean vac-storage
            const vacStorage = localStorage.getItem('vac-storage');
            if (vacStorage) {
                const parsed = JSON.parse(vacStorage);
                const charts = parsed.state?.charts || {};

                TO_DELETE.forEach(icao => {
                    if (charts[icao]) {
                        delete charts[icao];
                        deletedCount++;
                        logs.push(`‚úÖ Supprim√© ${icao} de vac-storage`);
                        console.log(`‚úÖ Supprim√© ${icao} de vac-storage`);
                    } else {
                        logs.push(`‚ö†Ô∏è ${icao} d√©j√† absent de vac-storage`);
                    }
                });

                localStorage.setItem('vac-storage', JSON.stringify(parsed));
            } else {
                logs.push('‚ö†Ô∏è vac-storage introuvable');
            }

            // 2. Clean customVACCharts
            const customCharts = localStorage.getItem('customVACCharts');
            if (customCharts) {
                const parsed = JSON.parse(customCharts);

                TO_DELETE.forEach(icao => {
                    if (parsed[icao]) {
                        delete parsed[icao];
                        logs.push(`‚úÖ Supprim√© ${icao} de customVACCharts`);
                        console.log(`‚úÖ Supprim√© ${icao} de customVACCharts`);
                    }
                });

                localStorage.setItem('customVACCharts', JSON.stringify(parsed));
            }

            // 3. Try to clean IndexedDB (vacPdfStorage)
            try {
                logs.push('üóÑÔ∏è Tentative de suppression des PDFs dans IndexedDB...');

                // Open IndexedDB
                const dbRequest = indexedDB.open('vacPdfStorage', 1);

                await new Promise((resolve, reject) => {
                    dbRequest.onsuccess = async (event) => {
                        const db = event.target.result;

                        if (db.objectStoreNames.contains('pdfs')) {
                            const transaction = db.transaction(['pdfs'], 'readwrite');
                            const store = transaction.objectStore('pdfs');

                            for (const icao of TO_DELETE) {
                                try {
                                    await new Promise((res, rej) => {
                                        const deleteRequest = store.delete(icao);
                                        deleteRequest.onsuccess = () => {
                                            logs.push(`‚úÖ PDF ${icao} supprim√© de IndexedDB`);
                                            res();
                                        };
                                        deleteRequest.onerror = () => {
                                            logs.push(`‚ö†Ô∏è PDF ${icao} introuvable dans IndexedDB`);
                                            res(); // Continue m√™me en cas d'erreur
                                        };
                                    });
                                } catch (err) {
                                    logs.push(`‚ö†Ô∏è Erreur suppression ${icao}: ${err.message}`);
                                }
                            }

                            db.close();
                            resolve();
                        } else {
                            logs.push('‚ö†Ô∏è Store "pdfs" introuvable dans IndexedDB');
                            resolve();
                        }
                    };

                    dbRequest.onerror = () => {
                        logs.push('‚ö†Ô∏è Impossible d\'ouvrir IndexedDB');
                        resolve(); // Continue m√™me en cas d'erreur
                    };
                });
            } catch (error) {
                logs.push(`‚ö†Ô∏è Erreur IndexedDB: ${error.message}`);
            }

            // Afficher r√©sultat
            setTimeout(() => {
                let html = '<div class="success">';
                html += `<h3>‚úÖ Nettoyage termin√©!</h3>`;
                html += `<p><strong>${deletedCount} VAC supprim√©s du localStorage</strong></p>`;
                html += '<h4>Logs d√©taill√©s :</h4>';
                html += '<pre>' + logs.join('\n') + '</pre>';
                html += '<p style="margin-top: 15px; font-weight: bold; color: #065f46;">üîÑ Rechargez la page pour voir les modifications</p>';
                html += '</div>';

                resultDiv.innerHTML = html;
                cleanupBtn.disabled = true;
                cleanupBtn.textContent = '‚úÖ Nettoyage effectu√©';
            }, 500);
        }
    </script>
</body>
</html>
