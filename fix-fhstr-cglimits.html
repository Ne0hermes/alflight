<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fix F-HSTR cgLimits</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    h1 { color: #4ec9b0; }
    button {
      background: #007acc;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
      margin: 10px 0;
    }
    button:hover { background: #005a9e; }
    #log {
      background: #252526;
      border: 1px solid #3c3c3c;
      padding: 15px;
      margin-top: 20px;
      border-radius: 4px;
      min-height: 200px;
      font-size: 14px;
    }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
    .warning { color: #dcdcaa; }
  </style>
</head>
<body>
  <h1>üîß Fix F-HSTR cgLimits</h1>
  <p>Ce script ajoute les cgLimits manquants pour l'avion F-HSTR (DA40 NG)</p>

  <button onclick="fixCgLimits()">‚ñ∂Ô∏è Ex√©cuter la correction</button>

  <div id="log"></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const logDiv = document.getElementById('log');

    function log(message, type = 'info') {
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
      logDiv.innerHTML += `<div class="${className}">${message}</div>`;
      console.log(message);
    }

    window.fixCgLimits = async function() {
      logDiv.innerHTML = '';
      log('üîß [FIX] D√©marrage de la correction cgLimits pour F-HSTR...');

      try {
        // Configuration Supabase
        const SUPABASE_URL = 'https://bgmscwckawgybymbimga.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJnbXNjd2NrYXdneWJ5bWJpbWdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NTk0MDAsImV4cCI6MjA3NTMzNTQwMH0.2J6nlClW_4GCdKaHrtjbf4AgdbDMpd_6auSzcMQnCMc';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        log('‚úÖ [FIX] Client Supabase cr√©√© avec succ√®s', 'success');

        // Chercher F-HSTR
        log('üì¶ [FIX] Recherche F-HSTR dans Supabase...');
        const { data: presets, error } = await supabase
          .from('community_presets')
          .select('*')
          .eq('registration', 'F-HSTR')
          .eq('status', 'active')
          .single();

        if (error) {
          log('‚ùå [FIX] Erreur Supabase: ' + error.message, 'error');
          return;
        }

        if (!presets) {
          log('‚ùå [FIX] F-HSTR non trouv√©', 'error');
          return;
        }

        const fhstr = presets;
        log('‚úÖ [FIX] F-HSTR trouv√©, ID: ' + fhstr.id, 'success');
        log('üìä [FIX] cgLimits AVANT: ' + JSON.stringify(fhstr.aircraft_data.weightBalance?.cgLimits), 'warning');

        // Nouveaux cgLimits (DA40 NG valeurs typiques)
        const newCgLimits = {
          forward: 2.05,  // 2.05 m (limite avant)
          aft: 2.31       // 2.31 m (limite arri√®re)
        };

        log('üìä [FIX] Nouveaux cgLimits (DA40 NG):');
        log('  - forward: ' + newCgLimits.forward + ' m');
        log('  - aft: ' + newCgLimits.aft + ' m');

        // Mettre √† jour dans Supabase
        log('üì¶ [FIX] Mise √† jour dans Supabase...');

        const updatedWeightBalance = {
          ...fhstr.aircraft_data.weightBalance,
          cgLimits: newCgLimits
        };

        const updatedAircraftData = {
          ...fhstr.aircraft_data,
          weightBalance: updatedWeightBalance
        };

        const { data: updated, error: updateError } = await supabase
          .from('community_presets')
          .update({
            aircraft_data: updatedAircraftData,
            updated_at: new Date().toISOString()
          })
          .eq('id', fhstr.id)
          .select()
          .single();

        if (updateError) {
          log('‚ùå [FIX] Erreur lors de la mise √† jour: ' + updateError.message, 'error');
          return;
        }

        log('');
        log('‚úÖ‚úÖ‚úÖ SUCC√àS ! ‚úÖ‚úÖ‚úÖ', 'success');
        log('');
        log('üìä [FIX] V√©rification finale:', 'success');
        log('  - cgLimits.forward: ' + updated.aircraft_data.weightBalance.cgLimits.forward + ' m', 'success');
        log('  - cgLimits.aft: ' + updated.aircraft_data.weightBalance.cgLimits.aft + ' m', 'success');
        log('');
        log('üîÑ Rechargez la page ALFlight (F5) pour voir les corrections', 'warning');

      } catch (error) {
        log('‚ùå [FIX] ERREUR CRITIQUE: ' + error.message, 'error');
        log('Stack: ' + error.stack, 'error');
      }
    };
  </script>
</body>
</html>
